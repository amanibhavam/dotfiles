apiVersion: v1
kind: Namespace
metadata:
  name: secrets
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: hello
  namespace: default
spec:
  dataFrom:
  - extract:
      key: /dev/meh
  refreshInterval: 15s
  secretStoreRef:
    kind: ClusterSecretStore
    name: dev
  target:
    name: hello
    template:
      data:
        config.yml: |
          - https://{{ .user }}:{{ .password }}@api.exmaple.com/global
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kyverno-sync-secrets
spec:
  rules:
  - generate:
      apiVersion: v1
      clone:
        name: kuma-global-generic-tls-cert
        namespace: secrets
      kind: Secret
      name: generic-tls-cert
      namespace: '{{request.object.metadata.name}}'
      synchronize: true
    match:
      any:
      - resources:
          kinds:
          - Namespace
          names:
          - kuma
    name: kuma-global-kds-server-tls
  - generate:
      apiVersion: v1
      clone:
        name: kuma-global-kds-server-tls
        namespace: secrets
      kind: Secret
      name: kds-server-tls
      namespace: '{{request.object.metadata.name}}'
      synchronize: true
    match:
      any:
      - resources:
          kinds:
          - Namespace
          names:
          - kuma
    name: kuma-global-generic-tls-cert
---
apiVersion: v1
kind: Pod
metadata:
  name: secrets
  namespace: secrets
spec:
  containers:
  - args:
    - sleep infinity
    command:
    - bash
    - -c
    image: ubuntu
    name: sleep
    volumeMounts:
    - mountPath: /mnt/secrets/kuma-global-kds-server-tls
      name: kuma-global-kds-server-tls
      readOnly: true
    - mountPath: /mnt/secrets/kuma-global-generic-tls-cert
      name: kuma-global-generic-tls-cert
      readOnly: true
  volumes:
  - name: kuma-global-kds-server-tls
    secret:
      optional: false
      secretName: kuma-global-kds-server-tls
  - name: kuma-global-generic-tls-cert
    secret:
      optional: false
      secretName: kuma-global-generic-tls-cert
